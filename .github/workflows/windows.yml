name: Windows

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_TRIPLET: x64-windows

    steps:
    - uses: actions/checkout@v4

    - name: Debug paths
      run: |
        echo "GITHUB_WORKSPACE=${{ github.workspace }}"
        echo "VCPKG_ROOT=${{ env.VCPKG_ROOT }}"
        echo "WORKDIR=$(pwd)"
        dir "%VCPKG_ROOT%"
      shell: cmd

    - name: Cache vcpkg artifacts
      uses: actions/cache@v4
      id: cache-vcpkg
      with:
        path: |
          ${{ env.VCPKG_ROOT }}\installed\${{ env.VCPKG_TRIPLET }}
          ${{ env.VCPKG_ROOT }}\packages
          ${{ env.VCPKG_ROOT }}\downloads
          ${{ github.workspace }}\vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-
          ${{ runner.os }}-vcpkg-

    - name: Show cache result & inspect installed
      run: |
        echo cache-hit=%CACHE_HIT%
        echo "cache-hit(official)=${{ steps.cache-vcpkg.outputs.cache-hit }}"
        if exist "%VCPKG_ROOT%\installed\%VCPKG_TRIPLET%" (
          echo "Installed dir contents:"
          dir "%VCPKG_ROOT%\installed\%VCPKG_TRIPLET%" /b
        ) else (
          echo "No installed dir at %VCPKG_ROOT%\installed\%VCPKG_TRIPLET%"
        )
        if exist "%GITHUB_WORKSPACE%\vcpkg_installed" (
          echo "repo vcpkg_installed contents:"
          dir "%GITHUB_WORKSPACE%\vcpkg_installed" /b
        ) else (
          echo "No repo vcpkg_installed at %GITHUB_WORKSPACE%\vcpkg_installed"
        )
      shell: cmd

    - name: Install dependencies on Windows
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/microsoft/vcpkg.git "%VCPKG_ROOT%"
        "%VCPKG_ROOT%\bootstrap-vcpkg.bat"
        "%VCPKG_ROOT%\vcpkg.exe" install gdal[core]:%VCPKG_TRIPLET% openscenegraph:%VCPKG_TRIPLET%
      shell: cmd

    - name: Build
      run: cargo build -vv --release